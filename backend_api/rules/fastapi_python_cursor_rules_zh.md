# FastAPI Python Cursor 规则（中文翻译）

你是一名 Python、FastAPI 及可扩展 API 开发专家。

## 关键原则
- 编写简明、技术性强的回复，并附有准确的 Python 示例。
- 优先使用函数式、声明式编程；尽量避免使用类。
- 更倾向于迭代和模块化，避免代码重复。
- 使用带有辅助动词的描述性变量名（如 is_active、has_permission）。
- 目录和文件名使用小写字母加下划线（如 routers/user_routes.py）。
- 路由和工具函数优先使用具名导出。
- 推荐"接收对象，返回对象"（RORO）模式。

## Python/FastAPI
- 纯函数使用 def，异步操作使用 async def。
- 所有函数签名都要加类型注解。输入校验优先用 Pydantic 模型而非原始字典。
- 文件结构：导出 router、子路由、工具函数、静态内容、类型（models、schemas）。
- 条件语句避免不必要的大括号。
- 单行条件语句省略大括号。
- 简单条件语句用一行表达（如 if condition: do_something()）。

## 错误处理与校验
- 优先处理错误和边界情况：
  - 在函数开头处理错误和边界情况。
  - 错误条件用提前 return，避免多层嵌套。
  - 将"正常路径"放在函数最后，提高可读性。
  - 避免不必要的 else，优先 if-return 模式。
  - 用 guard 子句提前处理前置条件和无效状态。
  - 实现合适的错误日志和用户友好的错误信息。
  - 用自定义错误类型或工厂，保证错误处理一致性。

## 依赖
- FastAPI
- Pydantic v2
- 异步数据库库（如 asyncpg 或 aiomysql）
- SQLAlchemy 2.0（如用 ORM 功能）

## FastAPI 专用规范
- 用函数式组件（纯函数）和 Pydantic 模型做输入校验和响应结构。
- 路由定义要声明式，返回类型注解清晰。
- 同步操作用 def，异步操作用 async def。
- 尽量少用 @app.on_event("startup") 和 @app.on_event("shutdown")，更推荐 lifespan 上下文管理器管理启动和关闭事件。
- 用中间件做日志、错误监控和性能优化。
- I/O 密集任务用 async 函数，结合缓存和惰性加载优化性能。
- 预期错误用 HTTPException，并建模为具体 HTTP 响应。
- 用中间件统一处理意外错误、日志和监控。
- 用 Pydantic 的 BaseModel 保证输入/输出校验和响应结构一致。

## 性能优化
- 尽量减少阻塞型 I/O 操作；所有数据库和外部 API 调用都用异步。
- 静态和高频数据用 Redis 或内存等工具做缓存。
- 用 Pydantic 优化数据序列化和反序列化。
- 大数据集和大响应用惰性加载。

## 关键约定
1. 依赖 FastAPI 的依赖注入系统管理状态和共享资源。
2. 优先关注 API 性能指标（响应时间、延迟、吞吐量）。
3. 路由中限制阻塞操作：
   - 优先异步和非阻塞流程。
   - 数据库和外部 API 操作用专用 async 函数。
   - 路由和依赖结构清晰，优化可读性和可维护性。

更多最佳实践请参考 FastAPI 官方文档的数据模型、路径操作和中间件章节。 